<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script type="text/javascript" src="http://47.92.226.26/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="http://47.92.226.26/js/vue-2.2.2.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <style type="text/css">
        body,
        html,
        #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=notj5jZfhhHQvej1zwAkF1V7pU4jGtY7"></script>
    <title>阜外医院</title>
    <style>
        #content {
            position: absolute;
            width: 100%;
            bottom: 0px;
            text-align: center;
            z-index: 2;
            overflow: hidden;
        }

        .modal-content {
            background-color: rgba(16, 78, 139, 0.6);
            height: auto;
        }

        .column {
            padding: 0 -15px;
        }

        span {
            color: white;
        }

        ul a {
            color: white;
        }

        tr th,
        td {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
        }

        ul > li > a {
            color: rgba(255, 255, 255, 0.8);
            font-size: 16px;
        }

        .personal_info > tr {
            text-align: center;
        }

            .personal_info > tr > td {
                font-size: 16px;
            }

        #addr,
        #lal,
        #num,
        #name,
        #agend,
        #age {
            font-size: 16px;
            vertical-align: middle;
        }

        .panel {
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0);
            text-align: center;
        }

        thead {
            background-color: #1874CD;
        }

        #basiInfo {
            background-color: rgba(16, 78, 139, 0.6);
        }

        .copyright {
            width: auto;
            left: 50%;
            top: 98%;
            margin-left: -80px;
            margin-top: -20px;
            position: fixed;
        }

        .xindt {
            margin: 0 auto;
            width: 523px;
            height: 425px;
            background-color: #000;
        }

        p span {
            color: #fff;
            line-height: 150%;
            font-family: Verdana, "微软雅黑", "宋体";
            color: rgba(255, 255, 255, 0.8);
        }
    </style>

</head>

	<body>
		<div id="allmap"></div>
		<!-- 模态框（Modal） -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
			<div id="content">
				<div class="modal-content" id="app">
					<div class="container" style="margin-bottom:0;border: none solid #ddd;border-radius: 3px">
						<div class="row clearfix">
							<div class="col-md-12 column">
                                <div class="row clearfix">
                                    <div class="col-md-2 column">
                                        <div style="height: auto;margin-top: 20px;" v-for="(item,index) in this.data">
                                            <div>
                                                <img v-bind:src="item.headimg" alt="" style="height:100px;width:100px;border-radius: 50px">
                                            </div>
                                            <div style="text-align: center;margin: 10px 0 20px 0;">
                                                <span style="font-size: 18px;">{{item.patientname}}</span>
                                            </div>
                                            <table class="table table-hover">
                                                <colgroup>
                                                    <col width="50%">
                                                    <col width="50%">
                                                </colgroup>
                                                <tbody class="personal_info">
                                                    <tr>
                                                        <td>
                                                            编号
                                                        </td>
                                                        <td id="pid">
                                                            {{item.patientid}}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            性别
                                                        </td>
                                                        <td>
                                                            {{item.gender}}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            年龄
                                                        </td>
                                                        <td>
                                                            {{item.age}}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td>
                                                            体重
                                                        </td>
                                                        <td>{{item.weight}}</td>
                                                    </tr>
                                                </tbody>
                                            </table>

                                        </div>
                                    </div>
                                    <div class="col-md-6 column">
                                        <div class="tabbable" id="tabs-902637" style="margin-top: 70px;">
                                            <ul id="myTab" class="nav nav-tabs">
                                                <li class="active">
                                                    <a href="#panel-0" data-toggle="tab">病史</a>
                                                </li>
                                                <li>
                                                    <a href="#panel-01" data-toggle="tab">诊断记录</a>
                                                </li>
                                                <li>
                                                    <a href="#panel-02" data-toggle="tab">用药记录</a>
                                                </li>
                                                <li>
                                                    <a href="#panel-03" data-toggle="tab">手术记录</a>
                                                </li>
                                                <li>
                                                    <a href="#panel-04" data-toggle="tab">常用联系人</a>
                                                </li>
                                            </ul>
                                            <div class="tab-content" style="margin-top: 10px;height:190px;overflow-y:auto">
                                                <div class="tab-pane active panel" id="panel-0">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>序号</th>
                                                                <th>疾病名称</th>
                                                                <th>备注</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in this.history">
                                                                <td>{{index+1}}</td>
                                                                <td>{{item.medicalhistoryname}}</td>
                                                                <td>{{item.remark}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="tab-pane panel" id="panel-01">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>时间</th>
                                                                <th>诊断结果</th>
                                                                <th>主治医师</th>
                                                                <th>备注</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in this.diagnosis">
                                                                <td>{{item.diagnosetime}}</td>
                                                                <td>{{item.diagnose}}</td>
                                                                <td>{{item.doctor}}</td>
                                                                <td>{{item.remark}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="tab-pane panel" id="panel-02">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>时间</th>
                                                                <th>药品名称</th>
                                                                <th>剂量</th>
                                                                <th>备注</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in this.drug">
                                                                <td>{{item.usedrugidtime}}</td>
                                                                <td>{{item.usedrugidname}}</td>
                                                                <td>{{item.dosage}}</td>
                                                                <td>{{item.remark}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="tab-pane panel" id="panel-03">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>时间</th>
                                                                <th>手术名称</th>
                                                                <th>备注</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in this.operation">
                                                                <td>{{item.operationtime}}</td>
                                                                <td>{{item.operationname}}</td>
                                                                <td>{{item.remark}}</td>
                                                            </tr>

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="tab-pane panel" id="panel-04">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th>序号</th>
                                                                <th>姓名</th>
                                                                <th>关系</th>
                                                                <th>联系方式</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in this.contact">
                                                                <td>{{index+1}}</td>
                                                                <td>{{item.guardianname}}</td>
                                                                <td>{{item.appellation}}</td>
                                                                <td>{{item.cp}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 column" style="margin-top:80px;">
                                        <div class="panel" style="height: auto">
                                            <table class="table table-bordered table-condensed">
                                                <tbody>
                                                    <tr>
                                                        <td style="background-color:#41b883">
                                                            <h3><span>实时心电图</span></h3>
                                                        </td>
                                                        <td>
                                                            <div id="canvas" style="width: 210px;height: 189px;border:1px dashed #FFA500;padding: 2px;">
                                                                <!--<canvas id="can" style="width: 300px;height: 220px;"></canvas>-->
                                                                <img src="img/xdt.gif" style="width: 200px;height: 180px;" />
                                                            </div>

                                                        </td>
                                                    </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="col-md-1 column" style="margin-top:80px;">
                                        <table class="text-center" style="border: none;">
                                            <tr>
                                                <td>
                                                    <button type="button" style="width: 180px;height: 80px;" class="btn btn-success" @click="fly">开始起飞</button>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <button type="button" class="btn btn-danger" style="margin-top: 20px;width: 180px;height: 80px;" @click="cancel">取消</button>
                                                </td>
                                                </td>
                                            </tr>
                                        </table>
                                    </div>

                                </div>
							</div>
						</div>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->

		<div class="copyright">
			<span> ©&nbsp;云南省阜外心血管病医院版权所有</span>
		</div>
	</body>

</html>

<script src="js/心电图.js"></script>
<script type="text/javascript">
	// 百度地图API功能
	var map = new BMap.Map("allmap");
	var point = new BMap.Point(102.665457, 25.105624);
	map.centerAndZoom(point, 18);
	map.enableScrollWheelZoom(); //启用鼠标滚轮放大缩小
	var mapStyle = {
		style: "dark" //设置地图风格为高端黑					
	}
	var data = [{
			"featureType": "water",
			"elementType": "all",
			"stylers": {
				"color": "#021019"
			}
		},
		{
			"featureType": "highway",
			"elementType": "geometry.fill",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "highway",
			"elementType": "geometry.stroke",
			"stylers": {
				"color": "#147a92"
			}
		},
		{
			"featureType": "arterial",
			"elementType": "geometry.fill",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "arterial",
			"elementType": "geometry.stroke",
			"stylers": {
				"color": "#0b3d51"
			}
		},
		{
			"featureType": "local",
			"elementType": "geometry",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "land",
			"elementType": "all",
			"stylers": {
				"color": "#08304b"
			}
		},
		{
			"featureType": "railway",
			"elementType": "geometry.fill",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "railway",
			"elementType": "geometry.stroke",
			"stylers": {
				"color": "#08304b"
			}
		},
		{
			"featureType": "subway",
			"elementType": "geometry",
			"stylers": {
				"lightness": -70
			}
		},
		{
			"featureType": "building",
			"elementType": "geometry.fill",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "all",
			"elementType": "labels.text.fill",
			"stylers": {
				"color": "#857f7f"
			}
		},
		{
			"featureType": "all",
			"elementType": "labels.text.stroke",
			"stylers": {
				"color": "#000000"
			}
		},
		{
			"featureType": "building",
			"elementType": "geometry",
			"stylers": {
				"color": "#022338"
			}
		},
		{
			"featureType": "green",
			"elementType": "geometry",
			"stylers": {
				"color": "#062032"
			}
		},
		{
			"featureType": "boundary",
			"elementType": "all",
			"stylers": {
				"color": "#1e1c1c"
			}
		},
		{
			"featureType": "manmade",
			"elementType": "geometry",
			"stylers": {
				"color": "#022338"
			}
		},
		{
			"featureType": "poi",
			"elementType": "all",
			"stylers": {
				"visibility": "off"
			}
		},
		{
			"featureType": "all",
			"elementType": "labels.icon",
			"stylers": {
				"visibility": "off"
			}
		},
		{
			"featureType": "all",
			"elementType": "labels.text.fill",
			"stylers": {
				"color": "#2da0c6",
				"visibility": "on"
			}
		}
	]
	map.setMapStyle({
		styleJson: data
	});

	//病人
	//var json_data = [{
	//		"lng": 102.667631,
	//		"lat": 25.106303,
	//		"id": 001
	//	},
	//	{
	//		"lng": 102.668359,
	//		"lat": 25.105665,
	//		"id": 002
	//	},
	//	{
	//		"lng": 102.667325,
	//		"lat": 25.105567,
	//		"id": 003
	//	},
	//	{
	//		"lng": 102.667514,
	//		"lat": 25.10515,
	//		"id": 004
	//	},
	//	{
	//		"lng": 102.668215,
	//		"lat": 25.105207,
	//		"id": 005
	//	},
	//	{
	//		"lng": 102.67471,
	//		"lat": 25.107489,
	//		"id": 006
	//	},
	//	{
	//		"lng": 102.674656,
	//		"lat": 25.106786,
	//		"id": 007
	//	}
	//];

	function handelAddMarker(pt, url,data,i) {
		var myIcon = new BMap.Icon(url, new BMap.Size(36, 36));
		var marker = new BMap.Marker(pt, {
			icon: myIcon
		}); // 创建标注
		map.addOverlay(marker);
        pointArray[i] = new BMap.Point(data[i].lng, data[i].lat);
		(function() {
            var thePoint = data[i];
			marker.addEventListener("click",
				function() {
					//alert(thePoint.patientid)
                    vue.bind(thePoint.patientid);
					$("#myModal").modal("show");
					$(".modal-backdrop").removeClass("modal-backdrop fade in");
				});
		})();

    }

    var pointArray = new Array();
    function showpatient(data) {
        for (var i = 0; i < data.length; i++) {
            handelAddMarker(new BMap.Point(data[i].lng, data[i].lat), "./img/人物-正常.png",data,i);
        }
    }

	//var pointArray = new Array();
	//for(var i = 0; i < json_data.length; i++) {
	//	handelAddMarker(new BMap.Point(json_data[i].lng, json_data[i].lat), "./img/人物-正常.png");
	//}

	//无人机
	//var json_wdata = [
	//	{
	//		"lng": 102.675284,
	//		"lat": 25.108798,
	//		"id": 002
	//	}
	//];

	function handelAddDroneMarker(pt, url,data,i) {
		var myIcon = new BMap.Icon(url, new BMap.Size(36, 36));
		var marker = new BMap.Marker(pt, {
			icon: myIcon
		}); // 创建标注
		map.addOverlay(marker);
        pointArray[i] = new BMap.Point(data[i].lng, data[i].lat);
		(function() {
            var thePoint = data[i];
			marker.addEventListener("click",
				function() {
                    //alert(thePoint.droneid)
				});
		})();
	}

    //	var pointArray = new Array();
    function showdrone(data) {
        for (var i = 0; i < data.length; i++) {
            handelAddDroneMarker(new BMap.Point(data[i].lng, data[i].lat), "./img/无人机.png",data,i);
        }
    }

	//让所有点在视野范围内
	//map.setViewport(pointArray);
	//获取覆盖物位置
	function attribute(e) {
		var i = e.target;

		$("#myModal").modal("show");
		//$(".modal-backdrop").remove();//删除class值为modal-backdrop的标签，可去除阴影
		$(".modal-backdrop").removeClass("modal-backdrop fade in");
	}

	/**
	 *根据等级显示闪烁坐标点 
	 */
	//定义自定义覆盖物的构造函数  
	function ComplexCustomOverlay(point) {
		this._point = point;

	}
	// 继承API的BMap.Overlay  
	ComplexCustomOverlay.prototype = new BMap.Overlay();

    // 实现绘制方法
    ComplexCustomOverlay.prototype.draw = function () {
        var map = this._map;
        var pixel = map.pointToOverlayPixel(this._point);
        this._div.style.left = pixel.x - parseInt(this._arrow.style.left) + "px";
        this._div.style.top = pixel.y - 20 + "px";
    }

    function add_overlay(point_long, point_lat) {
        map.addOverlay(new ComplexCustomOverlay(new BMap.Point(point_long, point_lat)));
    }

    function patientcolor(grade) {
        // 实现初始化方法  
        ComplexCustomOverlay.prototype.initialize = function (map) {
            // 保存map对象实例 
            this._map = map;
            // 创建div元素，作为自定义覆盖物的容器  
            var div = this._div = document.createElement("div");
            div.style.position = "absolute";
            div.style.zIndex = BMap.Overlay.getZIndex(this._point.lat);

            // 可以根据参数设置元素外观
            div.style.height = "35px";
            div.style.width = "35px";

            var arrow = this._arrow = document.createElement("img");
            if (grade == 3) {
                arrow.src = "img/红.gif";
            }
            if (grade == 2) {
                arrow.src = "img/黄.gif";
            }
            arrow.style.width = "35px";
            arrow.style.height = "35px";
            arrow.style.left = "20px";
            div.appendChild(arrow);

            // 将div添加到覆盖物容器中  
            map.getPanes().labelPane.appendChild(div);
            return div;
        }
    }



	//if(grade == 1) {
 //       add_overlay(102.667325, 25.105567);
	//}
	//if(grade == 2) {
 //       add_overlay(102.667325, 25.105567);
	//}

	//飞行轨迹

	//调用方法具体为
	function addMarker(point, name, map) {
		if(name == "起点") {
			var myIcon = new BMap.Icon("./img/起点.png", new BMap.Size(45, 45), {});
			var marker = new BMap.Marker(point, {
				icon: myIcon
			}); // 创建标注
			map.addOverlay(marker); // 将标注添加到地图中
			marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
		}
    }

    var droneMk; //定义终点坐标展示的mark对象
    var myIcon2;
    function qidian(PointArr) {
        myIcon2 = new BMap.Icon("./img/无人机.png", new BMap.Size(36, 36), {}); //初始化终点坐标图标
        if (PointArr.length>1) {
            droneMk = new BMap.Marker(new BMap.Point(PointArr[1].lng, PointArr[1].lat), {
                icon: myIcon2
            });
        }
        // 创建标注
        map.addOverlay(droneMk); // 将标注添加到地图中
    }

    
    //temporary.push(PointArr[i]);
    var interval;
    function fly(PointArr) {
        if (PointArr.length != 0&&br==0) {
        qidian(PointArr);
        var temporary = []; //定义中间新取出的值放到一个新的数组里面
        var i = 0;

        interval = setInterval(function () {
            if (i >= PointArr.length) {
                clearInterval(interval);
                return;
            }
            else {
                i = i + 1;
                temporary.push(PointArr[i]);
                drowLine(map, temporary); //画线调用
                change(PointArr[i].lat, PointArr[i].lng);
            }

            }, 1000);
    }
    }

    function status(patientid) {
        $.ajax({
            type: 'Post',
            url: '../action/TPatient.ashx',
            data: {
                diseasestatusid: 1,
                patientid: patientid,
                op: "updatebypatientid"
            },
            dataType: 'text',
            success: function (data) {
                console.log(data);
            },
            error: function (XMLHttpRequest, textStatus) { //请求失败
                if (textStatus == 'timeout') {
                    var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                    xmlhttp.abort();
                    alert("请求超时");
                } else if (textStatus == "error") {
                    alert("服务器内部错误");
                }
            }
        })
    }

    function change(lat,lng) {
        $.ajax({
            type: 'Post',
            url: '../action/Flightpath.ashx',
            data: {
                lat: lat,
                lng:lng,
                op: "change"
            },
            dataType: 'json',
            success: function (data) {
                console.log(data);
            },
            error: function (XMLHttpRequest, textStatus) { //请求失败
                if (textStatus == 'timeout') {
                    var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                    xmlhttp.abort();
                    alert("请求超时");
                } else if (textStatus == "error") {
                    alert("服务器内部错误");
                }
            }
        })
    }
    var br = 0;
	function drowLine(map, temporary) {
		if(temporary && temporary.length > 1) { //判断数值为两个点时开始进行绘制
			for(var i = 0; i < temporary.length - 1; i++) {
				var polyline = new BMap.Polyline(
					[
						new BMap.Point(temporary[i].lng, temporary[i].lat),
						new BMap.Point(temporary[i + 1].lng, temporary[i + 1].lat)
					], {
						strokeColor: "green", //设置颜色 
						strokeWeight: 8, //宽度
						strokeOpacity: 0.8 //透明度
					}); //创建折线
				map.addOverlay(polyline);
                addMarkerEnd(new BMap.Point(temporary[i + 1].lng, temporary[i + 1].lat), '终点', map); //添加图标
                if (br==0) {
                    if (zdlat == temporary[i + 1].lat && zdlng == temporary[i + 1].lng) {
                        status(patientid);
                        br =1;
                        map.clearOverlays();
                    }
                    if (hzdlat == temporary[i + 1].lat && hzdlng == temporary[i + 1].lng) {
                        status(hpatientid);
                        br = 1;
                        map.clearOverlays();
                    }
                }
			}
		}
	}

	function addMarkerEnd(point, name, map) {
		if(name == "终点") {
			if(droneMk) {
				map.removeOverlay(droneMk);
			}
			droneMk = new BMap.Marker(point, {
				icon: myIcon2
			}); // 创建标注
			map.addOverlay(droneMk); // 将标注添加到地图中
		}
    }
    var zdlat;
    var zdlng;
    var patientid;
    var red = 0;
    var yellow = 0;
    var hzdlat;
    var hzdlng;
    var hpatientid;
    var click = 0;
    function showdata() {
        $.ajax({
            type: 'Post',
            url: '../action/map.ashx',
            data: {
                op: "load"
            },
            dataType: 'json',
            success: function (data) {
                //var json = [];
                //json = data.split('|-|');
                //var data1 = JSON.parse(json[0]);
                //var data2 = JSON.parse(json[1]);

                var data1 = JSON.parse(data.Data1);
                var data2 = JSON.parse(data.Data2);
                //map.clearOverlays();
                for (var i = 0; i < data1.length; i++) {
                    patientcolor(data1[i].diseasestatusid);
                    if (data1[i].diseasestatusid == 2) {
                        if (yellow==0) {
                            alert("黄色预警");
                            yellow = 1;
                        }
                        add_overlay(data1[i].lng, data1[i].lat);
                        hzdlat = data1[i].lat;
                        hzdlng = data1[i].lng;
                        hpatientid = data1[i].patientid;
                        if (click==1) {
                            searchdrone(data1[i].droneid);
                        }
                    }
                    if (data1[i].diseasestatusid == 3) {
                        
                        if (red == 0) {
                            alert("红色预警");
                            red = 1;
                        }
                        add_overlay(data1[i].lng, data1[i].lat);
                        zdlat = data1[i].lat;
                        zdlng = data1[i].lng;
                        patientid = data1[i].patientid;
                        searchdrone(data1[i].droneid);
                    }
                }
                
                showpatient(data1);
                showdrone(data2);
            },
            error: function (XMLHttpRequest, textStatus) { //请求失败
                if (textStatus == 'timeout') {
                    var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                    xmlhttp.abort();
                    alert("请求超时");
                } else if (textStatus == "error") {
                    alert("请求失败，请重试");
                }
            }
        })
    }

    function deletePoint(lng) {
        lng = 102.669612;
        var allOverlay = map.getOverlays();
        for (var i = 0; i < allOverlay.length; i++) {
            if (allOverlay[i].getPosition().lng == lng) {
                map.removeOverlay(allOverlay[i]);
                return false;
            }
        }
    }

    var ref = setInterval(function () {
        showdata();
    }, 1000);

    function searchdrone(droneid) {
        $.ajax({
            type: 'Post',
            url: '../action/Flightpath.ashx',
            data: {
                droneid: droneid,
                op: "bydrone"
            },
            dataType: 'json',
            success: function (data) {
                console.log(data);
                var data1 = JSON.parse(data.Data1);
                var data2 = JSON.parse(data.Data2);
                //addMarker(new BMap.Point(data2[0].lng, data2[0].lat), '起点', map);

                fly(data1);
            },
            error: function (XMLHttpRequest, textStatus) { //请求失败
                if (textStatus == 'timeout') {
                    var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                    xmlhttp.abort();
                    alert("请求超时");
                } else if (textStatus == "error") {
                    alert("服务器内部错误");
                }
            }
        })
    }

    var vue = new Vue({
        el: "#app",
        data: {
            data: [],
        },
        history: {
            history: [],
        },
        diagnosis: {
            diagnosis: [],
        },
        drug: {
            drug: [],
        },
        operation: {
            operation: [],
        },
        contact: {
            contact: [],
        },
        created: function () {
            this.loadData(); //页面加载
        },
        methods: {
            loadData: function () {
                var _this = this;
                $.ajax({
                    type: 'Post',
                    url: '../action/map.ashx',
                    data: {
                        op: "load"
                    },
                    dataType: 'json',
                    success: function (data) {
                        var data1 = JSON.parse(data.Data1);
                        var data2 = JSON.parse(data.Data2);
                        //map.clearOverlays();
                        showpatient(data1);
                        showdrone(data2);
                    },
                    error: function (XMLHttpRequest, textStatus) { //请求失败
                        if (textStatus == 'timeout') {
                            var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                            xmlhttp.abort();
                            alert("请求超时");
                        } else if (textStatus == "error") {
                            alert("服务器内部错误");
                        }
                    }
                })
            },
            bind: function (patientid) {
                var _this = this;
                $.ajax({
                    type: 'Post',
                    url: '../action/map.ashx',
                    data: {
                        patientid: patientid,
                        op: "search"
                    },
                    dataType: 'json',
                    success: function (data) {
                        console.log(data);
                        //var json = [];
                        //json = data.split('|-|');
                        //var data1 = JSON.parse(json[0]);
                        //var data2 = JSON.parse(json[1]);
                        //var data3 = JSON.parse(json[2]);
                        //var data4 = JSON.parse(json[3]);
                        //var data5 = JSON.parse(json[4]);
                        //var data6 = JSON.parse(json[5]);

                        var data1 = JSON.parse(data.Data1);
                        var data2 = JSON.parse(data.Data2);
                        var data3 = JSON.parse(data.Data3);
                        var data4 = JSON.parse(data.Data4);
                        var data5 = JSON.parse(data.Data5);
                        var data6 = JSON.parse(data.Data6);
                        _this.data = data1;
                        _this.history = data2;
                        _this.diagnosis = data3;
                        _this.drug = data4;
                        _this.operation = data5;
                        _this.contact = data6;
                    },
                    error: function (XMLHttpRequest, textStatus) { //请求失败
                        if (textStatus == 'timeout') {
                            var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                            xmlhttp.abort();
                            alert("请求超时");
                        } else if (textStatus == "error") {
                            alert("服务器内部错误");
                        }
                    }
                })
            },
            fly: function () {
                click = 1;
            },
            cancel: function () {
                var droneid = $("#pid").text();
                searchdrone(droneid);
                $("#myModal").modal("hide");
            }
        },
    });
</script>